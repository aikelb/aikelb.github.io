<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Migrando a easyengine v4 - Aitor Lozano</title>
<meta name="description" content="¡easyengine se ha actualizado y ahora funciona con docker! Es una actualización muy potente, pero que cambia mucho la forma de trabajar (especialmente con la base de datos).">


  <meta name="author" content="Aitor Lozano">
  
  <meta property="article:author" content="Aitor Lozano">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Aitor Lozano">
<meta property="og:title" content="Migrando a easyengine v4">
<meta property="og:url" content="http://localhost:4000/guide/migrando-a-easyengine-v4/">


  <meta property="og:description" content="¡easyengine se ha actualizado y ahora funciona con docker! Es una actualización muy potente, pero que cambia mucho la forma de trabajar (especialmente con la base de datos).">



  <meta property="og:image" content="http://localhost:4000/assets/posts/easyengine.jpg">





  <meta property="article:published_time" content="2019-02-14T00:00:00+00:00">






<link rel="canonical" href="http://localhost:4000/guide/migrando-a-easyengine-v4/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Aitor Lozano Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Aitor Lozano
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">About me</a>
            </li><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/ulpgc/">ULPGC</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="/assets/posts/easyengine.jpg" alt="Migrando a easyengine v4" class="page__hero-image">
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/images/bio-photo.jpg" alt="Aitor Lozano" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Aitor Lozano</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Unity3D Developer @ PlayMedusa</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://aitorlozano.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AikeLB" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/aikelb" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Migrando a easyengine v4">
    <meta itemprop="description" content="¡easyengine se ha actualizado y ahora funciona con docker!Es una actualización muy potente, pero que cambia mucho la forma de trabajar (especialmente con la base de datos).">
    <meta itemprop="datePublished" content="2019-02-14T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/guide/migrando-a-easyengine-v4/" class="u-url" itemprop="url">Migrando a easyengine v4
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <p>¡<a href="https://easyengine.io/">easyengine</a> se ha actualizado y ahora funciona con docker!
Es una actualización muy potente, pero que cambia mucho la forma de trabajar (especialmente con la base de datos).</p>

<p>Empecemos con la migración a otro servidor paso a paso.</p>

<h1 id="paso-1-exportar-el-contenido-y-la-base-de-datos">Paso 1: Exportar el contenido y la base de datos.</h1>

<p>Todo el contenido relevante de un sitio web wordpress (entradas, plugins, temas, imágenes…) está almacenado dentro del directorio <strong>wp-content</strong>.
Lo podemos comprimir utilizando <em>tar</em> fácilmente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zcvf ~/site_name.tar.gz ./wp-content
</code></pre></div></div>

<p>Es importante el directorio desde el que hacemos la compresión, ya que al descomprimir mantendrá todas los directorios tal cual se han comprimido.</p>

<p>Lo siguiente es exportar la BBDD. Es bastante fácil utilizando el usuario root, y ya que estamos, lo comprimimos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo mysqldump -u root dbname &gt; dbname.sql
tar -zcvf dbname.sql.tar.gz dbname.sql
</code></pre></div></div>

<h1 id="paso-2-copiar-el-contenido-al-servidor-nuevo">Paso 2: Copiar el contenido al servidor nuevo</h1>

<p>Esto podemos hacerlo como más cómodo nos sea. Hay quien prefiere rsync, o ftp. Para mi lo más fácil es scp:
Desde el servidor nuevo podríamos hacer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp user@oldserver.com:~/*.tar.gz .
</code></pre></div></div>

<h1 id="paso-3-instalar-easyengine-y-crear-el-sitio-web">Paso 3: Instalar easyengine y crear el sitio web</h1>

<p>Como indican en la web de easyengine, su instalación es muy sencilla:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget -qO ee rt.cx/ee4 &amp;&amp; sudo bash ee
</code></pre></div></div>

<p>Cuando termine, podremos crear el sitio web con cache en una línea:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ee site create domain.com --type=wp --cache=wpredis
</code></pre></div></div>

<h1 id="paso-4-restauramos-los-datos">Paso 4: Restauramos los datos</h1>
<p>Empezamos descomprimiendo el contenido del sitio en su nuevo directorio y actualizando los permisos de la carpeta:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd opt/easyengine/sites/domain.com/app/htdocs
tar -zxvf archive_name.tar.gz
chown -R www-data:www-data wp-content
</code></pre></div></div>

<p>Restaurar la BBDD tiene truco. Ya no podemos acceder a mysql como en el servidor anterior porque ahora es un contenedor de docker.
Lo primero que necesitamos es obtener el identificador del container:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># docker ps
CONTAINER ID        IMAGE                           COMMAND                  CREATED             STATUS              PORTS                                      NAMES
f3c3a1fc727c        easyengine/mariadb:v4.0.0       "docker-entrypoint.s…"   3 minutes ago       Up 3 minutes        3306/tcp                                   services_global-db_1
</code></pre></div></div>

<p>En el listado buscamos el id del contenedor de mariadb.
No sabemos cual es la contraseña de root de la base de datos, pero podemos conectarnos al contenedor con los datos del blog que acabamos de montar con algo de este estilo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker exec -i f3c3a1fc727c mysql -udbuser -pdbpass --database=dbname &lt; dump.sql
</code></pre></div></div>

<p>Si por lo que fuera, necesitamos acceder a la BBDD como root, podemos usar:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker exec -it f3c3a1fc727c bash -c 'mysql -uroot -p${MYSQL_ROOT_PASSWORD}'
</code></pre></div></div>

<p>Y no estaría de más limpiar el historial de comandos que contiene la contraseña de las BBDD:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>history -c
</code></pre></div></div>

<h1 id="paso-5-activamos-el-ssl">Paso 5: Activamos el SSL</h1>

<p>Una vez hayamos cambiado el dominio y se haya propagado por los servidores de DNS, podremos activar el SSL con letsencrypt:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ee site update example.com --ssl=le

# O si queremos * subdominios:
# ee site update example.com --ssl=le --wildcard
</code></pre></div></div>

<h1 id="otros-comandos-y-resolución-de-problemas">Otros comandos y resolución de problemas</h1>

<h2 id="renovación-de-caché">Renovación de caché</h2>
<p>Si necesitamos forzar una renovación de la caché y no podemos acceder al panel de admin, podemos relanzar el servicio de redis con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ee service restart redis
</code></pre></div></div>

<h2 id="reinicios-del-servidor">Reinicios del servidor</h2>
<p>Hay veces que al reiniciar el servidor la BBDD o algún otro servicio de easyengine no arranca correctamente.
Es un bug conocido, por ahora una forma de evitarlo es reiniciando de nuevo o ejecutando:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ee service enable db --force
</code></pre></div></div>

<h2 id="redirecciones-www">Redirecciones www</h2>
<p>Por algún motivo aunque tengamos bien configurado el subdominio www, nginx no hace bien la redirección para servirlo. Especialmente cuando hay varias páginas en un mismo servidor.
Esto puede ser porque falte el fichero en el servicio de nginx-proxy que resuelve esta redirección.
El archivo debe estar en la ruta <code class="language-plaintext highlighter-rouge">/opt/easyengine/services/nginx-proxy/conf.d/domain.com-redirect.conf</code> y su contenido debería ser:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  listen  80;
  server_name  www.domain.com;
  return  301 http://domain.com$request_uri;
}
</code></pre></div></div>

<p>Una vez lo tengamos, con recargar el servicio debería bastar:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ee service reload nginx-proxy
</code></pre></div></div>

<h2 id="error-nginx-emerg-host-not-found-in-upstream">Error nginx: [emerg] host not found in upstream</h2>
<p>Este problema se puede dar por dos motivos:</p>
<h3 id="1-nginx-intenta-lanzarse-y-la-dependencia-php-fpm-no-está-en-marcha">1. Nginx intenta lanzarse y la dependencia php-fpm no está en marcha.</h3>
<p>En el docker-compose de cada sitio se establece esa dependencia, pero durante el arranque a veces puede fallar el inicio de una de las dependencias. La solución más rápida es desactivar y volver a activar el sitio. De esta forma easyengine parará y elminará todas las instancias de docker y las volverá a lanzar en el orden correcto.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ee site disable domain.com
ee site enable domain.com
</code></pre></div></div>
<h3 id="2-no-se-puede-resolver-las-dns-del-dominio">2. No se puede resolver las dns del dominio.</h3>
<p>En las últimas versiones de Nginx, la validación de las dns del dominio pueden comprobarse por IPv6. 
Para arreglarlo, simplemente hay que configurar correctamente un registro AAAA apuntando a la IPv6 de nuestro servidor en @.</p>

<p><a href="https://venturedawn.com/blogging/migrate-wordpress-easyengine-v4/2667/">Fuente</a>.
<a href="https://community.easyengine.io/t/502-bad-gateway-error-after-server-reboot/11717/3">Error 502</a></p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#guide" class="page__taxonomy-item p-category" rel="tag">Guide</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2019-02-14T00:00:00+00:00">February 14, 2019</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Migrando+a+easyengine+v4%20http%3A%2F%2Flocalhost%3A4000%2Fguide%2Fmigrando-a-easyengine-v4%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fguide%2Fmigrando-a-easyengine-v4%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fguide%2Fmigrando-a-easyengine-v4%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/guide/intellisense-unity-linux/" class="pagination--pager" title="Intellisense en Ubuntu con Unity 2018+
">Previous</a>
    
    
      <a href="/guide/serve-unity-webgl-using-nginx/" class="pagination--pager" title="Servir build WebGL de Unity utilizando NGINX
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You May Also Enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/guide/local-streaming/" rel="permalink">Streaming local de vídeos en Unity3D
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">El streaming de vídeos puede resolver muchos problemas si intentamos utilizar algún plugin que espera una URL como entrada.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/guide/serve-unity-webgl-using-nginx/" rel="permalink">Servir build WebGL de Unity utilizando NGINX
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Nota rápida para evitar problemas a la hora de servir una build WebGL con compresión utilizando NGINX.
El resumen es que tenemos estalecer los tipos MIME par...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/guide/intellisense-unity-linux/" rel="permalink">Intellisense en Ubuntu con Unity 2018+
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Mientras utilizaba VSCode con Unity en Ubuntu 18.10 como editor principal, al llegar las últimas actualizaciones dejó de funcionar el autocompletado con un f...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/guide/l2tp-ubuntu/" rel="permalink">L2TP IPsec VPN en Ubuntu
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Hace poco tuve que conectarme a una VPN bajo el protocolo L2TP mientras trabajaba en Ubuntu. Por defecto este protocolo no está soportado en Ubuntu 18.10, pe...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/AikeLB" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/aikelb" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Aitor Lozano. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
